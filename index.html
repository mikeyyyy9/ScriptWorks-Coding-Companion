<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScriptWorks Coding AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  height: 100%;
  background: black;
  color: white;
  font-family: "Inter", Arial, sans-serif;
  overflow: hidden;
}

/* STARFIELD CANVAS */
canvas {
  position: fixed;
  inset: 0;
  z-index: 0;
}

/* MAIN LAYOUT */
#layout {
  position: relative;
  z-index: 2;
  height: 100%;
  display: flex;
  gap: 20px;
  padding: 20px;
  box-sizing: border-box;
}

/* SIDEBAR */
#sidebar {
  width: 240px;
  background: rgba(0,0,0,0.55);
  border: 1px solid #222;
  border-radius: 14px;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-sizing: border-box;
}

#sidebarTitle {
  font-size: 14px;
  font-weight: 600;
  color: #e5e7eb;
  margin-bottom: 4px;
}

#newChatBtn {
  background: #111;
  border: 1px solid #333;
  padding: 10px 12px;
  color: white;
  cursor: pointer;
  border-radius: 12px;
  font-size: 14px;
  transition: 0.2s;
  text-align: center;
}
#newChatBtn:hover {
  background: #222;
}

#chatList {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chatItem {
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #333;
  background: rgba(255,255,255,0.05);
  cursor: pointer;
  transition: 0.2s;
  font-size: 13px;
  color: #e5e7eb;
}
.chatItem:hover {
  background: rgba(255,255,255,0.12);
}

/* MAIN CHAT AREA */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: rgba(0,0,0,0.55);
  border: 1px solid #222;
  border-radius: 14px;
  overflow: hidden;
}

/* HEADER */
#header {
  padding: 16px;
  font-size: 18px;
  font-weight: 600;
  border-bottom: 1px solid #222;
  background: rgba(0,0,0,0.7);
  text-align: center;
  letter-spacing: 0.4px;
  color: #e5e7eb;
}
#headerSubtitle {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 4px;
}

/* CHAT AREA */
#chat {
  flex: 1;
  padding: 25px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-sizing: border-box;
}

/* PLAIN MESSAGES (NO BUBBLES) */
.message {
  font-size: 15px;
  line-height: 1.5;
  white-space: pre-wrap;
}
.message.user {
  align-self: flex-end;
  text-align: right;
  color: #dbeafe;
}
.message.ai {
  align-self: flex-start;
  text-align: left;
  color: #e5e7eb;
}

/* SCRIPT BUBBLE */
.script-bubble {
  background: #1f1f1f;
  border-radius: 14px;
  padding: 0;
  overflow: hidden;
  margin-top: 6px;
  border: 1px solid #333;
  max-width: 100%;
}

.script-bubble-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: #181818; /* darker gray top bar */
  border-bottom: 1px solid #333;
  font-size: 13px;
  color: #e5e7eb;
}

.script-title {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.script-copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: transparent;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 12px;
  padding: 4px 6px;
}
.script-copy-btn:hover {
  color: #e5e7eb;
}

.script-copy-icon {
  font-size: 12px;
}

/* SCRIPT CONTENT */
.script-content {
  padding: 10px 12px 12px 12px;
  background: #111;
  font-family: "JetBrains Mono", "Fira Code", monospace;
  font-size: 13px;
  color: #e5e7eb;
  overflow-x: auto;
  white-space: pre;
}

/* TYPING INDICATOR */
.typing-indicator {
  align-self: flex-start;
  background: #111827;
  color: #e5e7eb;
  border-radius: 999px;
  padding: 8px 12px;
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.typing-dot {
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: #9ca3af;
  animation: blink 1.2s infinite ease-in-out;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
  40% { opacity: 1; transform: translateY(-2px); }
}

/* INPUT BAR */
#inputBar {
  display: flex;
  border-top: 1px solid #222;
  background: rgba(0,0,0,0.7);
  padding: 10px 14px;
  box-sizing: border-box;
}

#inputWrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #020617;
  border-radius: 999px;
  border: 1px solid #1f2937;
  padding: 6px 10px 6px 14px;
  flex: 1;
}

#msg {
  flex: 1;
  background: transparent;
  border: none;
  color: white;
  padding: 6px 0;
  outline: none;
  font-size: 14px;
  resize: none;
  max-height: 120px;
}

#sendBtn {
  background: #6b21a8;
  border: none;
  color: white;
  padding: 8px 14px;
  cursor: pointer;
  font-size: 14px;
  border-radius: 999px;
}
#sendBtn:hover {
  background: #7e22ce;
}

/* SCROLLBARS */
#chatList::-webkit-scrollbar,
#chat::-webkit-scrollbar {
  width: 6px;
}
#chatList::-webkit-scrollbar-thumb,
#chat::-webkit-scrollbar-thumb {
  background: #333;
  border-radius: 999px;
}
</style>
</head>
<body>

<canvas id="stars"></canvas>

<div id="layout">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sidebarTitle">Chats</div>
    <button id="newChatBtn" onclick="newChat()">+ New Chat</button>
    <div id="chatList"></div>
  </div>

  <!-- MAIN CHAT -->
  <div id="main">
    <div id="header">
      ScriptWorks Coding AI
      <div id="headerSubtitle">Your intelligent coding companion</div>
    </div>

    <div id="chat"></div>

    <div id="inputBar">
      <div id="inputWrapper">
        <textarea id="msg" placeholder="Ask me anything about coding..." rows="1"></textarea>
        <button id="sendBtn" onclick="send()">Send</button>
      </div>
    </div>
  </div>

</div>

<script>
/* -------------------------
   CHAT STORAGE SYSTEM
--------------------------*/
let chats = JSON.parse(localStorage.getItem("scriptworks_chats") || "{}");
let currentChatId = localStorage.getItem("scriptworks_current_chat") || null;

const chatBox = document.getElementById("chat");
const input = document.getElementById("msg");
const chatList = document.getElementById("chatList");
const sendBtn = document.getElementById("sendBtn");

let typingIndicatorEl = null;

function saveChats() {
  localStorage.setItem("scriptworks_chats", JSON.stringify(chats));
}

function saveCurrentChat() {
  if (currentChatId) {
    localStorage.setItem("scriptworks_current_chat", currentChatId);
  }
}

function newChat() {
  currentChatId = "chat_" + Date.now();
  chats[currentChatId] = [];
  saveChats();
  saveCurrentChat();
  renderChatList();
  renderChat();
}

function loadChat(id) {
  currentChatId = id;
  saveCurrentChat();
  renderChat();
}

function renderChatList() {
  chatList.innerHTML = "";
  Object.keys(chats).forEach(id => {
    const first = chats[id][0]?.text || "New Chat";
    const title = first.substring(0, 30) + (first.length > 30 ? "..." : "");
    const div = document.createElement("div");
    div.className = "chatItem";
    div.textContent = title;
    div.onclick = () => loadChat(id);
    chatList.appendChild(div);
  });
}

function clearChatBox() {
  chatBox.innerHTML = "";
}

function renderChat() {
  clearChatBox();
  if (!currentChatId || !chats[currentChatId]) return;

  chats[currentChatId].forEach(m => {
    if (m.type === "script") {
      addScriptBubble(m.title, m.text, false);
    } else {
      addMessage(m.role, m.text, false);
    }
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

function addMessage(role, text, save = true) {
  const div = document.createElement("div");
  div.className = `message ${role}`;
  div.textContent = text;
  chatBox.appendChild(div);

  if (save && currentChatId) {
    chats[currentChatId].push({ role, text, type: "text" });
    saveChats();
    renderChatList();
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}

function addScriptBubble(title, code, save = true) {
  const wrapper = document.createElement("div");
  wrapper.className = "script-bubble";

  const header = document.createElement("div");
  header.className = "script-bubble-header";

  const titleEl = document.createElement("div");
  titleEl.className = "script-title";
  titleEl.textContent = title || "Generated Script";

  const copyBtn = document.createElement("button");
  copyBtn.className = "script-copy-btn";
  copyBtn.innerHTML = `<span class="script-copy-icon">ðŸ“„</span><span>Copy</span>`;
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(code || "").catch(() => {});
  };

  header.appendChild(titleEl);
  header.appendChild(copyBtn);

  const content = document.createElement("pre");
  content.className = "script-content";
  content.textContent = code || "";

  wrapper.appendChild(header);
  wrapper.appendChild(content);
  chatBox.appendChild(wrapper);

  if (save && currentChatId) {
    chats[currentChatId].push({ role: "ai", text: code, type: "script", title });
    saveChats();
    renderChatList();
  }

  chatBox.scrollTop = chatBox.scrollHeight;
}

/* -------------------------
   TYPING INDICATOR
--------------------------*/
function showTypingIndicator() {
  removeTypingIndicator();
  typingIndicatorEl = document.createElement("div");
  typingIndicatorEl.className = "typing-indicator";
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement("div");
    dot.className = "typing-dot";
    typingIndicatorEl.appendChild(dot);
  }
  chatBox.appendChild(typingIndicatorEl);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function removeTypingIndicator() {
  if (typingIndicatorEl && typingIndicatorEl.parentNode) {
    typingIndicatorEl.parentNode.removeChild(typingIndicatorEl);
  }
  typingIndicatorEl = null;
}

/* -------------------------
   PROMPT TITLE SUMMARIZER
--------------------------*/
function summarizePrompt(prompt) {
  if (!prompt) return "Generated Script";

  let p = prompt.toLowerCase();
  const fillers = [
    "make me", "make a", "make the", "make", "create me", "create a", "create the", "create",
    "can you", "could you", "please", "for me", "for my game", "for my", "write me", "write a",
    "generate", "give me", "i need", "i want", "build me", "build a"
  ];
  fillers.forEach(f => {
    p = p.replace(f, "");
  });

  p = p.replace(/\s+/g, " ").trim();
  if (!p) return "Generated Script";

  const words = p.split(" ");
  const maxWords = 5;
  const sliced = words.slice(0, maxWords);
  const titleRaw = sliced.join(" ");

  const title = titleRaw.split(" ").map(w => {
    if (!w) return "";
    if (w.length <= 3) return w.toUpperCase();
    return w.charAt(0).toUpperCase() + w.slice(1);
  }).join(" ").trim();

  return title || "Generated Script";
}

/* -------------------------
   SCRIPT DETECTION
--------------------------*/
function handleAiResponse(userPrompt, aiText) {
  // Look for code block ```...```
  const codeBlockRegex = /```[\s\S]*?```/;
  const match = aiText.match(codeBlockRegex);

  if (!match) {
    // No code, just plain AI message
    addMessage("ai", aiText);
    return;
  }

  const codeBlock = match[0];
  let code = codeBlock.replace(/```[\s\S]*?\n?/, "").replace(/```$/, "");
  code = code.trim();

  const before = aiText.slice(0, match.index).trim();
  const after = aiText.slice(match.index + codeBlock.length).trim();

  if (before) addMessage("ai", before);
  const title = summarizePrompt(userPrompt);
  addScriptBubble(title, code);
  if (after) addMessage("ai", after);
}

/* -------------------------
   SEND MESSAGE (CALL BACKEND)
--------------------------*/
async function send() {
  if (!input.value.trim() || !currentChatId) return;

  const text = input.value;
  input.value = "";
  autoResizeTextarea();

  addMessage("user", text);

  showTypingIndicator();

  try {
    const response = await fetch("https://scriptworks-coding-companion.onrender.com/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });

    const data = await response.json();
    removeTypingIndicator();

    if (data.error) {
      addMessage("ai", "API error: " + (data.error.message || "Unknown error"));
      return;
    }

    const aiReply = data.choices?.[0]?.message?.content || "No response from AI.";
    handleAiResponse(text, aiReply);
  } catch (err) {
    removeTypingIndicator();
    addMessage("ai", "Network error talking to backend.");
  }
}

/* -------------------------
   INPUT BEHAVIOR
--------------------------*/
function autoResizeTextarea() {
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 120) + "px";
}

input.addEventListener("input", autoResizeTextarea);

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

/* -------------------------
   INITIALIZE
--------------------------*/
renderChatList();
if (!currentChatId || !chats[currentChatId]) {
  newChat();
} else {
  renderChat();

/* ensure currentChatId is saved */
  saveCurrentChat();
}

/* -------------------------
   STARFIELD BACKGROUND
--------------------------*/
const canvas = document.getElementById("stars");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

let stars = Array.from({ length: 160 }, () => ({
  x: Math.random() * canvas.width,
  y: Math.random() * canvas.height,
  s: Math.random() * 2 + 0.5
}));

function animate() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "white";

  stars.forEach(star => {
    star.y += star.s;
    if (star.y > canvas.height) star.y = 0;
    ctx.fillRect(star.x, star.y, 2, 2);
  });

  requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
